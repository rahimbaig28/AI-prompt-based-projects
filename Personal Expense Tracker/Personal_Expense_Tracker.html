<!-- Prompt!
 
Personal Expense Tracker (categories + charts)
Generate ONE self-contained HTML file (inline CSS and JS) “Expense Tracker”.
- Add expenses: date, category, amount, note.
- Category manager (add/rename/delete categories).
- Summary cards: total this month, average per day, top 3 categories.
- Simple bar chart and pie chart using <canvas> (vanilla JS, no libraries).
- Filter by date range and category; export CSV; import CSV (append or overwrite).
- localStorage persistence; responsive and accessible.
- Clean UI and well-commented code. No external files.

-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --border-radius: 8px;
        }

        /* Basic Reset & Font */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        header h1 {
            color: var(--dark-color);
        }

        /* Main Grid Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        /* Generic Card Styling */
        .card {
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
        }
        
        /* Controls Bar */
        .controls-bar, .filter-bar, .io-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .filter-bar {
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover { background-color: var(--primary-dark); }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        .btn-success:hover { background-color: #218838; }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover { background-color: #c82333; }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }
        .btn-warning:hover { background-color: #e0a800; }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        /* Form Elements */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-top: 4px;
        }
        
        label {
            font-weight: 500;
            font-size: 0.9rem;
            color: #555;
        }

        .form-group {
            margin-bottom: 16px;
        }

        /* Summary Dashboard */
        .summary-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }
        
        .summary-card.alt {
            background: linear-gradient(135deg, var(--secondary-color), var(--dark-color));
            box-shadow: 0 4px 10px rgba(52, 58, 64, 0.3);
        }
        
        .summary-card.alt-2 {
            background: linear-gradient(135deg, var(--success-color), #1e7e34);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
        }

        .summary-card h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .summary-card .details {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 8px;
            min-height: 2.5em; /* Ensure consistent height */
        }
        
        .summary-card .details ol {
            padding-left: 20px;
            margin: 0;
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .chart-wrapper {
            position: relative;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .chart-wrapper h3 {
            text-align: center;
            margin-bottom: 16px;
        }
        
        canvas {
            max-width: 100%;
            max-height: 350px;
        }
        
        #pieChartLegend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 16px;
            list-style: none;
        }
        
        #pieChartLegend li {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .legend-color-box {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            border-radius: 3px;
        }

        /* Expense Table */
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--light-color);
            font-weight: 600;
            color: var(--secondary-color);
        }

        tbody tr:hover {
            background-color: #f1f3f5;
        }
        
        td:last-child {
            text-align: right;
        }
        
        .expense-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: var(--bg-color);
            margin: 10vh auto;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            position: relative;
            animation: slideIn 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        .close-btn {
            color: var(--secondary-color);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close-btn:hover { color: var(--dark-color); }

        /* Category Manager List */
        #category-list {
            list-style: none;
            margin-top: 16px;
        }
        
        #category-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 8px;
        }
        
        #category-list li.editing .category-name {
            display: none;
        }
        #category-list li:not(.editing) .edit-input {
            display: none;
        }
        
        .category-actions {
            display: flex;
            gap: 8px;
        }

        /* Import Modal */
        .import-options {
            display: flex;
            gap: 20px;
            margin: 16px 0;
        }
        
        .import-options label {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .summary-dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls-bar, .filter-bar, .io-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-bar .btn {
                width: 100%;
            }
        }

    </style>
</head>
<body>

    <div class="container">
        
        <header>
            <h1>Expense Tracker</h1>
            <div class="controls-bar">
                <button class="btn btn-primary" id="addExpenseBtn" aria-label="Add new expense">Add Expense</button>
                <button class="btn btn-secondary" id="manageCategoriesBtn" aria-label="Manage categories">Manage Categories</button>
            </div>
        </header>

        <main class="main-layout">

            <section class="card">
                <h2>Dashboard</h2>
                <div class="summary-dashboard">
                    <div class="summary-card">
                        <h3>Total This Month</h3>
                        <div class="value" id="totalMonth">€0.00</div>
                        <div class="details" id="totalMonthDetails"></div>
                    </div>
                    <div class="summary-card alt">
                        <h3>Average Per Day</h3>
                        <div class="value" id="avgDay">€0.00</div>
                        <div class="details" id="avgDayDetails">(Based on filtered range)</div>
                    </div>
                    <div class="summary-card alt-2">
                        <h3>Top Categories</h3>
                        <div class="value" id="topCategoryName">N/A</div>
                        <div class="details" id="topCategoryDetails">
                            </div>
                    </div>
                </div>
            </section>
            
            <section class="card">
                <h2>Visuals</h2>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h3 id="pieChartTitle">Expenses by Category</h3>
                        <canvas id="pieChart"></canvas>
                        <ul id="pieChartLegend"></ul>
                    </div>
                    <div class="chart-wrapper">
                        <h3 id="barChartTitle">Expenses by Day</h3>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2>Transactions</h2>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label for="filterStartDate">From</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div class="filter-group">
                        <label for="filterEndDate">To</label>
                        <input type="date" id="filterEndDate">
                    </div>
                    <div class="filter-group">
                        <label for="filterCategory">Category</label>
                        <select id="filterCategory">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="filterBtn">Filter</button>
                    <button class="btn btn-secondary" id="resetFilterBtn">Reset</button>
                </div>
                
                <div class="io-bar">
                    <button class="btn btn-success" id="exportCsvBtn">Export CSV</button>
                    <button class="btn btn-warning" id="importCsvBtn">Import CSV</button>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody">
                            </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <div id="expenseModal" class="modal" role="dialog" aria-labelledby="expenseModalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="expenseModalTitle">Add Expense</h2>
                <span class="close-btn" data-dismiss="expenseModal" aria-label="Close">&times;</span>
            </div>
            <form id="expenseForm">
                <input type="hidden" id="expenseId">
                <div class="form-group">
                    <label for="expenseDate">Date</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label for="expenseCategory">Category</label>
                    <select id="expenseCategory" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="expenseAmount">Amount (€)</label>
                    <input type="number" id="expenseAmount" min="0.01" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="expenseNote">Note (Optional)</label>
                    <input type="text" id="expenseNote" placeholder="e.g., Lunch with client">
                </div>
                <button type="submit" class="btn btn-primary" id="expenseFormSubmitBtn">Add Expense</button>
            </form>
        </div>
    </div>

    <div id="categoriesModal" class="modal" role="dialog" aria-labelledby="categoriesModalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="categoriesModalTitle">Manage Categories</h2>
                <span class="close-btn" data-dismiss="categoriesModal" aria-label="Close">&times;</span>
            </div>
            
            <h3>Add New Category</h3>
            <form id="categoryForm" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="newCategoryName" placeholder="Category Name" required style="flex-grow: 1;">
                <button type="submit" class="btn btn-success">Add</button>
            </form>
            
            <h3>Existing Categories</h3>
            <ul id="category-list">
                </ul>
        </div>
    </div>
    
    <div id="importModal" class="modal" role="dialog" aria-labelledby="importModalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="importModalTitle">Import CSV</h2>
                <span class="close-btn" data-dismiss="importModal" aria-label="Close">&times;</span>
            </div>
            <form id="importForm">
                <div class="form-group">
                    <label for="csvFile">Select CSV File</label>
                    <input type="file" id="csvFile" accept=".csv" required>
                </div>
                <div class="form-group">
                    <p>Import Mode:</p>
                    <div class="import-options">
                        <label>
                            <input type="radio" name="importMode" value="append" checked>
                            Append (Add to existing data)
                        </label>
                        <label>
                            <input type="radio" name="importMode" value="overwrite">
                            Overwrite (Replace all data)
                        </label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Import</button>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE & STORAGE ---
            let expenses = [];
            let categories = [];
            
            const UNCATEGORIZED_ID = 0;
            const STORAGE_KEYS = {
                expenses: 'expenseTracker_expenses_v2',
                categories: 'expenseTracker_categories_v2'
            };

            const DEFAULT_CATEGORIES = [
                { id: UNCATEGORIZED_ID, name: 'Uncategorized' },
                { id: 1, name: 'Food' },
                { id: 2, name: 'Transport' },
                { id: 3, name: 'Utilities' },
                { id: 4, name: 'Entertainment' },
            ];

            // --- DOM SELECTORS ---
            const modalSelectors = {
                expenseModal: document.getElementById('expenseModal'),
                categoriesModal: document.getElementById('categoriesModal'),
                importModal: document.getElementById('importModal'),
            };
            
            const btnSelectors = {
                addExpenseBtn: document.getElementById('addExpenseBtn'),
                manageCategoriesBtn: document.getElementById('manageCategoriesBtn'),
                importCsvBtn: document.getElementById('importCsvBtn'),
                exportCsvBtn: document.getElementById('exportCsvBtn'),
                filterBtn: document.getElementById('filterBtn'),
                resetFilterBtn: document.getElementById('resetFilterBtn'),
            };

            const formSelectors = {
                expenseForm: document.getElementById('expenseForm'),
                expenseId: document.getElementById('expenseId'),
                expenseDate: document.getElementById('expenseDate'),
                expenseCategory: document.getElementById('expenseCategory'),
                expenseAmount: document.getElementById('expenseAmount'),
                expenseNote: document.getElementById('expenseNote'),
                expenseFormSubmitBtn: document.getElementById('expenseFormSubmitBtn'),
                expenseModalTitle: document.getElementById('expenseModalTitle'),
                
                categoryForm: document.getElementById('categoryForm'),
                newCategoryName: document.getElementById('newCategoryName'),
                categoryList: document.getElementById('category-list'),
                
                importForm: document.getElementById('importForm'),
                csvFile: document.getElementById('csvFile'),
            };

            const filterSelectors = {
                startDate: document.getElementById('filterStartDate'),
                endDate: document.getElementById('filterEndDate'),
                category: document.getElementById('filterCategory'),
            };

            const displaySelectors = {
                expenseTableBody: document.getElementById('expenseTableBody'),
                totalMonth: document.getElementById('totalMonth'),
                totalMonthDetails: document.getElementById('totalMonthDetails'),
                avgDay: document.getElementById('avgDay'),
                avgDayDetails: document.getElementById('avgDayDetails'),
                topCategoryName: document.getElementById('topCategoryName'),
                topCategoryDetails: document.getElementById('topCategoryDetails'),
                pieChart: document.getElementById('pieChart'),
                pieChartLegend: document.getElementById('pieChartLegend'),
                barChart: document.getElementById('barChart'),
                pieChartTitle: document.getElementById('pieChartTitle'),
                barChartTitle: document.getElementById('barChartTitle'),
            };

            // Chart contexts
            const pieCtx = displaySelectors.pieChart.getContext('2d');
            const barCtx = displaySelectors.barChart.getContext('2d');
            let chartColors = [];

            // --- HELPER FUNCTIONS ---

            /**
             * Formats a number as currency (EUR)
             * @param {number} amount - The amount to format
             * @returns {string} - Formatted currency string
             */
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
            };

            /**
             * Formats a date to 'YYYY-MM-DD'
             * @param {Date} date - The date object
             * @returns {string} - Formatted date string
             */
            const formatDate = (date) => {
                if (!(date instanceof Date)) {
                    date = new Date(date);
                }
                return date.toISOString().split('T')[0];
            };
            
            /**
             * Generates a unique ID
             * @returns {number} - A timestamp-based ID
             */
            const generateId = () => Date.now();
            
            /**
             * Generates a set of visually distinct colors for charts
             * @param {number} numColors - Number of colors to generate
             */
            const generateChartColors = (numColors) => {
                chartColors = [];
                for (let i = 0; i < numColors; i++) {
                    const hue = (i * 360 / numColors) % 360;
                    chartColors.push(`hsl(${hue}, 70%, 60%)`);
                }
            };

            /**
             * Gets category name from its ID
             * @param {number} id - The category ID
             * @returns {string} - The category name
             */
            const getCategoryName = (id) => {
                const category = categories.find(c => c.id === id);
                return category ? category.name : 'Uncategorized';
            };

            // --- LOCAL STORAGE ---

            /**
             * Saves the current state (expenses and categories) to localStorage
             */
            const saveData = () => {
                localStorage.setItem(STORAGE_KEYS.expenses, JSON.stringify(expenses));
                localStorage.setItem(STORAGE_KEYS.categories, JSON.stringify(categories));
            };

            /**
             * Loads state from localStorage
             */
            const loadData = () => {
                const storedExpenses = localStorage.getItem(STORAGE_KEYS.expenses);
                const storedCategories = localStorage.getItem(STORAGE_KEYS.categories);
                
                expenses = storedExpenses ? JSON.parse(storedExpenses) : [];
                categories = storedCategories ? JSON.parse(storedCategories) : [...DEFAULT_CATEGORIES];
                
                // Ensure "Uncategorized" always exists
                if (!categories.find(c => c.id === UNCATEGORIZED_ID)) {
                    categories.unshift({ id: UNCATEGORIZED_ID, name: 'Uncategorized' });
                }
            };

            // --- MODAL HANDLING ---

            /**
             * Opens a modal
             * @param {HTMLElement} modal - The modal element to open
             */
            const openModal = (modal) => {
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden', 'false');
            };

            /**
             * Closes a modal
             * @param {HTMLElement} modal - The modal element to close
             */
            const closeModal = (modal) => {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            };

            /**
             * Sets up listeners for all modal close buttons
             */
            const setupModalListeners = () => {
                document.querySelectorAll('[data-dismiss]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const modalId = btn.getAttribute('data-dismiss');
                        closeModal(modalSelectors[modalId]);
                    });
                });
                
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        closeModal(e.target);
                    }
                });
            };

            // --- RENDER FUNCTIONS ---

            /**
             * Master render function. Called after any data change.
             */
            const render = () => {
                // Get filtered expenses based on current filter inputs
                const filteredExpenses = getFilteredExpenses();

                // Update all parts of the UI
                renderCategoryOptions();
                renderCategoriesList();
                renderExpenseTable(filteredExpenses);
                renderDashboard(filteredExpenses);
                renderCharts(filteredExpenses);
            };
            
            /**
             * Populates the category dropdowns in the expense form and filter
             */
            const renderCategoryOptions = () => {
                const optionsHtml = categories
                    .map(c => `<option value="${c.id}">${c.name}</option>`)
                    .join('');
                
                formSelectors.expenseCategory.innerHTML = optionsHtml;
                filterSelectors.category.innerHTML = `
                    <option value="all">All Categories</option>
                    ${optionsHtml}
                `;
            };

            /**
             * Renders the list of categories in the management modal
             */
            const renderCategoriesList = () => {
                displaySelectors.categoryList.innerHTML = categories.map(c => `
                    <li data-id="${c.id}" class="${c.id === UNCATEGORIZED_ID ? 'uncategorized' : ''}">
                        <span class="category-name">${c.name}</span>
                        <input type="text" class="edit-input" value="${c.name}">
                        
                        ${c.id !== UNCATEGORIZED_ID ? `
                        <div class="category-actions">
                            <button class="btn btn-warning btn-small edit-category-btn">Rename</button>
                            <button class="btn btn-success btn-small save-category-btn" style="display:none;">Save</button>
                            <button class="btn btn-danger btn-small delete-category-btn">Delete</button>
                        </div>
                        ` : `<span>(Default)</span>`}
                    </li>
                `).join('');
            };

            /**
             * Renders the main expense table
             * @param {Array} expensesToRender - The array of expense objects to display
             */
            const renderExpenseTable = (expensesToRender) => {
                displaySelectors.expenseTableBody.innerHTML = '';
                if (expensesToRender.length === 0) {
                    displaySelectors.expenseTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No expenses found.</td></tr>';
                    return;
                }
                
                // Sort by date descending
                const sortedExpenses = [...expensesToRender].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedExpenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.dataset.id = expense.id;
                    row.innerHTML = `
                        <td>${formatDate(expense.date)}</td>
                        <td>${getCategoryName(expense.categoryId)}</td>
                        <td>${formatCurrency(expense.amount)}</td>
                        <td>${expense.note || ''}</td>
                        <td>
                            <div class="expense-actions">
                                <button class="btn btn-warning btn-small edit-expense-btn" aria-label="Edit expense">Edit</button>
                                <button class="btn btn-danger btn-small delete-expense-btn" aria-label="Delete expense">Delete</button>
                            </div>
                        </td>
                    `;
                    displaySelectors.expenseTableBody.appendChild(row);
                });
            };

            /**
             * Updates the summary dashboard cards
             * @param {Array} filteredExpenses - The currently filtered expenses
             */
            const renderDashboard = (filteredExpenses) => {
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                // 1. Total This Month
                const monthExpenses = expenses.filter(e => {
                    const d = new Date(e.date);
                    return d >= firstDayOfMonth && d <= lastDayOfMonth;
                });
                const totalMonth = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
                displaySelectors.totalMonth.textContent = formatCurrency(totalMonth);
                displaySelectors.totalMonthDetails.textContent = `(${formatDate(firstDayOfMonth)} to ${formatDate(lastDayOfMonth)})`;
                
                // 2. Average Per Day (based on filtered range)
                let avgDay = 0;
                let days = 1;
                if (filteredExpenses.length > 0) {
                    const dates = filteredExpenses.map(e => new Date(e.date));
                    const minDate = new Date(Math.min(...dates));
                    const maxDate = new Date(Math.max(...dates));
                    const timeDiff = Math.abs(maxDate.getTime() - minDate.getTime());
                    days = Math.max(1, Math.ceil(timeDiff / (1000 * 60 * 60 * 24)) + 1);
                    
                    const totalFiltered = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
                    avgDay = totalFiltered / days;
                }
                displaySelectors.avgDay.textContent = formatCurrency(avgDay);
                displaySelectors.avgDayDetails.textContent = `(Over ${days} day${days > 1 ? 's' : ''} in filter)`;


                // 3. Top 3 Categories (based on filtered range)
                const categoryTotals = {};
                filteredExpenses.forEach(e => {
                    const name = getCategoryName(e.categoryId);
                    categoryTotals[name] = (categoryTotals[name] || 0) + e.amount;
                });
                
                const sortedCategories = Object.entries(categoryTotals)
                    .sort(([, a], [, b]) => b - a);

                if (sortedCategories.length > 0) {
                    displaySelectors.topCategoryName.textContent = sortedCategories[0][0];
                    const top3List = sortedCategories.slice(0, 3)
                        .map(([name, total]) => `<li>${name}: ${formatCurrency(total)}</li>`)
                        .join('');
                    displaySelectors.topCategoryDetails.innerHTML = `<ol>${top3List}</ol>`;
                } else {
                    displaySelectors.topCategoryName.textContent = 'N/A';
                    displaySelectors.topCategoryDetails.innerHTML = '(No data in range)';
                }
            };

            // --- CHARTING FUNCTIONS (VANILLA CANVAS) ---

            /**
             * Main function to render both charts
             * @param {Array} filteredExpenses - The currently filtered expenses
             */
            const renderCharts = (filteredExpenses) => {
                // Aggregate data for charts
                const categoryData = {};
                const dayData = {};

                filteredExpenses.forEach(e => {
                    const name = getCategoryName(e.categoryId);
                    categoryData[name] = (categoryData[name] || 0) + e.amount;
                    
                    const date = formatDate(e.date);
                    dayData[date] = (dayData[date] || 0) + e.amount;
                });
                
                // --- Pie Chart Data ---
                const pieChartData = Object.entries(categoryData)
                    .map(([name, value]) => ({ label: name, value }))
                    .sort((a, b) => b.value - a.value);
                
                // --- Bar Chart Data ---
                const sortedDays = Object.entries(dayData).sort(([a], [b]) => new Date(a) - new Date(b));
                const barChartData = {
                    labels: sortedDays.map(([date]) => date.slice(5)), // Format as 'MM-DD'
                    values: sortedDays.map(([, value]) => value)
                };

                // Generate colors
                generateChartColors(pieChartData.length);
                
                // Set titles
                const filterActive = filterSelectors.startDate.value || filterSelectors.endDate.value || filterSelectors.category.value !== 'all';
                const rangeText = filterActive ? "(Filtered)" : "(All Time)";
                displaySelectors.pieChartTitle.textContent = `Expenses by Category ${rangeText}`;
                displaySelectors.barChartTitle.textContent = `Expenses by Day ${rangeText}`;

                // Draw
                drawPieChart(pieChartData);
                drawBarChart(barChartData);
            };

            /**
             * Draws the Pie Chart on its canvas
             * @param {Array} data - [{label, value}, ...]
             */
            const drawPieChart = (data) => {
                const canvas = displaySelectors.pieChart;
                const legend = displaySelectors.pieChartLegend;
                pieCtx.clearRect(0, 0, canvas.width, canvas.height);
                legend.innerHTML = '';
                
                if (data.length === 0) {
                    pieCtx.fillStyle = '#777';
                    pieCtx.textAlign = 'center';
                    pieCtx.font = '16px Arial';
                    pieCtx.fillText('No data to display', canvas.width / 2, canvas.height / 2);
                    return;
                }

                const total = data.reduce((sum, { value }) => sum + value, 0);
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = Math.min(centerX, centerY) - 20;
                
                let startAngle = -0.5 * Math.PI; // Start at the top

                data.forEach(({ label, value }, index) => {
                    const sliceAngle = (value / total) * 2 * Math.PI;
                    const endAngle = startAngle + sliceAngle;
                    const color = chartColors[index % chartColors.length];

                    // Draw Slice
                    pieCtx.beginPath();
                    pieCtx.moveTo(centerX, centerY);
                    pieCtx.arc(centerX, centerY, radius, startAngle, endAngle);
                    pieCtx.closePath();
                    pieCtx.fillStyle = color;
                    pieCtx.fill();

                    // Draw Label (percentage)
                    const midAngle = startAngle + sliceAngle / 2;
                    const textRadius = radius * 0.7;
                    const x = centerX + Math.cos(midAngle) * textRadius;
                    const y = centerY + Math.sin(midAngle) * textRadius;
                    const percent = (value / total) * 100;
                    
                    if (percent > 5) { // Only show label if slice is > 5%
                        pieCtx.fillStyle = '#fff';
                        pieCtx.font = 'bold 12px Arial';
                        pieCtx.textAlign = 'center';
                        pieCtx.textBaseline = 'middle';
                        pieCtx.fillText(`${percent.toFixed(0)}%`, x, y);
                    }
                    
                    startAngle = endAngle;
                    
                    // Add to Legend
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="legend-color-box" style="background-color: ${color}"></span>
                        ${label} (${formatCurrency(value)})
                    `;
                    legend.appendChild(li);
                });
            };
            
            /**
             * Draws the Bar Chart on its canvas
             * @param {Object} data - { labels: [], values: [] }
             */
            const drawBarChart = (data) => {
                const canvas = displaySelectors.barChart;
                barCtx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (data.values.length === 0) {
                    barCtx.fillStyle = '#777';
                    barCtx.textAlign = 'center';
                    barCtx.font = '16px Arial';
                    barCtx.fillText('No data to display', canvas.width / 2, canvas.height / 2);
                    return;
                }

                const padding = 50;
                const chartWidth = canvas.width - 2 * padding;
                const chartHeight = canvas.height - 2 * padding;
                const maxValue = Math.max(0, ...data.values);
                const barWidth = chartWidth / (data.values.length * 2 - 1); // Give some spacing
                
                const scaleY = maxValue > 0 ? chartHeight / maxValue : 0;
                
                // Draw Y-axis & labels
                barCtx.beginPath();
                barCtx.moveTo(padding, padding);
                barCtx.lineTo(padding, chartHeight + padding);
                barCtx.stroke();
                
                barCtx.fillStyle = '#555';
                barCtx.textAlign = 'right';
                barCtx.textBaseline = 'middle';
                barCtx.font = '12px Arial';
                
                const numGridLines = 5;
                for (let i = 0; i <= numGridLines; i++) {
                    const value = (maxValue / numGridLines) * i;
                    const y = chartHeight + padding - (value * scaleY);
                    barCtx.fillText(formatCurrency(value).replace('€', ''), padding - 10, y);
                    
                    // Draw grid line
                    barCtx.beginPath();
                    barCtx.moveTo(padding, y);
                    barCtx.lineTo(padding + chartWidth, y);
                    barCtx.strokeStyle = '#eee';
                    barCtx.stroke();
                }

                // Draw X-axis
                barCtx.beginPath();
                barCtx.moveTo(padding, chartHeight + padding);
                barCtx.lineTo(padding + chartWidth, chartHeight + padding);
                barCtx.strokeStyle = '#333';
                barCtx.stroke();
                
                // Draw Bars
                data.values.forEach((value, index) => {
                    const x = padding + index * (barWidth * 1.5); // 1.5 for spacing
                    const y = chartHeight + padding - (value * scaleY);
                    const height = value * scaleY;
                    
                    barCtx.fillStyle = chartColors[0]; // Use primary color for bars
                    barCtx.fillRect(x, y, barWidth, height);
                    
                    // Draw X-axis label
                    barCtx.save();
                    barCtx.translate(x + barWidth / 2, chartHeight + padding + 10);
                    barCtx.rotate(Math.PI / 4); // Rotate label 45 degrees
                    barCtx.textAlign = 'left';
                    barCtx.textBaseline = 'top';
                    barCtx.fillStyle = '#555';
                    barCtx.fillText(data.labels[index], 0, 0);
                    barCtx.restore();
                });
            };


            // --- FILTERING ---

            /**
             * Gets expenses based on the current filter values
             * @returns {Array} - The filtered array of expenses
             */
            const getFilteredExpenses = () => {
                const start = filterSelectors.startDate.value;
                const end = filterSelectors.endDate.value;
                const categoryId = filterSelectors.category.value;
                
                return expenses.filter(expense => {
                    const d = new Date(expense.date);
                    if (start && d < new Date(start)) return false;
                    if (end && d > new Date(end)) return false;
                    if (categoryId !== 'all' && expense.categoryId !== parseInt(categoryId)) return false;
                    return true;
                });
            };

            // --- EVENT HANDLERS ---

            /**
             * Handles submission of the Add/Edit Expense form
             */
            const handleExpenseFormSubmit = (e) => {
                e.preventDefault();
                
                const id = formSelectors.expenseId.value;
                const expenseData = {
                    date: formSelectors.expenseDate.value,
                    categoryId: parseInt(formSelectors.expenseCategory.value),
                    amount: parseFloat(formSelectors.expenseAmount.value),
                    note: formSelectors.expenseNote.value.trim(),
                };

                if (id) {
                    // Update existing expense
                    const index = expenses.findIndex(e => e.id === parseInt(id));
                    if (index > -1) {
                        expenses[index] = { ...expenses[index], ...expenseData };
                    }
                } else {
                    // Add new expense
                    expenses.push({ ...expenseData, id: generateId() });
                }
                
                saveData();
                render();
                closeModal(modalSelectors.expenseModal);
                formSelectors.expenseForm.reset();
            };

            /**
             * Opens the expense modal in "Add" mode
             */
            const showAddExpenseModal = () => {
                formSelectors.expenseForm.reset();
                formSelectors.expenseId.value = '';
                formSelectors.expenseDate.value = formatDate(new Date()); // Default to today
                formSelectors.expenseModalTitle.textContent = 'Add Expense';
                formSelectors.expenseFormSubmitBtn.textContent = 'Add Expense';
                openModal(modalSelectors.expenseModal);
            };

            /**
             * Opens the expense modal in "Edit" mode
             * @param {number} id - The ID of the expense to edit
             */
            const showEditExpenseModal = (id) => {
                const expense = expenses.find(e => e.id === id);
                if (!expense) return;
                
                formSelectors.expenseId.value = expense.id;
                formSelectors.expenseDate.value = formatDate(expense.date);
                formSelectors.expenseCategory.value = expense.categoryId;
                formSelectors.expenseAmount.value = expense.amount;
                formSelectors.expenseNote.value = expense.note;
                
                formSelectors.expenseModalTitle.textContent = 'Edit Expense';
                formSelectors.expenseFormSubmitBtn.textContent = 'Update Expense';
                openModal(modalSelectors.expenseModal);
            };

            /**
             * Handles clicks within the expense table (Edit/Delete)
             */
            const handleExpenseTableClick = (e) => {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;
                
                const id = parseInt(row.dataset.id);

                if (target.classList.contains('delete-expense-btn')) {
                    if (confirm('Are you sure you want to delete this expense?')) {
                        expenses = expenses.filter(e => e.id !== id);
                        saveData();
                        render();
                    }
                }
                
                if (target.classList.contains('edit-expense-btn')) {
                    showEditExpenseModal(id);
                }
            };
            
            /**
             * Handles submission of the new category form
             */
            const handleCategoryFormSubmit = (e) => {
                e.preventDefault();
                const name = formSelectors.newCategoryName.value.trim();
                if (name && !categories.find(c => c.name.toLowerCase() === name.toLowerCase())) {
                    categories.push({ id: generateId(), name });
                    saveData();
                    render(); // Re-render everything to update dropdowns
                    formSelectors.newCategoryName.value = '';
                } else if (name) {
                    alert('Category name already exists.');
                }
            };

            /**
             * Handles clicks within the category management list
             */
            const handleCategoryListClick = (e) => {
                const target = e.target;
                const li = target.closest('li');
                if (!li) return;
                
                const id = parseInt(li.dataset.id);
                
                if (target.classList.contains('delete-category-btn')) {
                    if (confirm('Are you sure? This will move all expenses in this category to "Uncategorized".')) {
                        // Re-assign expenses
                        expenses.forEach(expense => {
                            if (expense.categoryId === id) {
                                expense.categoryId = UNCATEGORIZED_ID;
                            }
                        });
                        // Delete category
                        categories = categories.filter(c => c.id !== id);
                        saveData();
                        render(); // Re-render all
                    }
                }
                
                if (target.classList.contains('edit-category-btn')) {
                    // Enter edit mode
                    li.classList.add('editing');
                    li.querySelector('.edit-input').focus();
                    target.style.display = 'none';
                    li.querySelector('.save-category-btn').style.display = 'inline-block';
                }
                
                if (target.classList.contains('save-category-btn')) {
                    // Save edit mode
                    const newName = li.querySelector('.edit-input').value.trim();
                    if (newName && !categories.find(c => c.id !== id && c.name.toLowerCase() === newName.toLowerCase())) {
                        const category = categories.find(c => c.id === id);
                        category.name = newName;
                        li.classList.remove('editing');
                        saveData();
                        render(); // Re-render all
                    } else if (newName) {
                        alert('Category name already exists or is invalid.');
                    }
                }
            };
            
            /**
             * Handles filter button click
             */
            const handleFilter = () => {
                // Just need to re-render, as render() pulls from filter values
                render();
            };

            /**
             * Resets all filters and re-renders
             */
            const handleResetFilter = () => {
                filterSelectors.startDate.value = '';
                filterSelectors.endDate.value = '';
                filterSelectors.category.value = 'all';
                render();
            };

            // --- CSV IMPORT / EXPORT ---
            
            /**
             * Exports all expenses to a CSV file
             */
            const exportToCSV = () => {
                const headers = 'id,date,categoryName,amount,note\n';
                const rows = expenses.map(e => {
                    const categoryName = getCategoryName(e.categoryId);
                    const note = `"${(e.note || '').replace(/"/g, '""')}"`; // Escape quotes
                    return [e.id, formatDate(e.date), categoryName, e.amount, note].join(',');
                }).join('\n');
                
                const csvContent = headers + rows;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) { // Feature detection
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `expenses_${formatDate(new Date())}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };
            
            /**
             * Handles submission of the import form
             */
            const handleImportCSV = (e) => {
                e.preventDefault();
                const file = formSelectors.csvFile.files[0];
                const mode = document.querySelector('input[name="importMode"]:checked').value;
                
                if (!file) {
                    alert('Please select a file.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csv = event.target.result;
                        const lines = csv.split(/\r?\n/).filter(line => line.trim() !== '');
                        
                        if (lines.length <= 1) {
                            alert('File is empty or has no data.');
                            return;
                        }
                        
                        const headerLine = lines.shift().toLowerCase();
                        // Simple header check, can be more robust
                        if (!headerLine.includes('date') || !headerLine.includes('categoryname') || !headerLine.includes('amount')) {
                           throw new Error('Invalid CSV headers. Must include "date", "categoryName", and "amount".');
                        }
                        
                        const newExpenses = [];
                        lines.forEach((line, index) => {
                            // Simple CSV parse, not robust for complex quotes
                            const [id, date, categoryName, amount, note] = line.split(',');
                            
                            if (!date || !categoryName || !amount) {
                                console.warn(`Skipping malformed line ${index + 2}: ${line}`);
                                return;
                            }
                            
                            // Find or create category
                            let category = categories.find(c => c.name.toLowerCase() === categoryName.trim().toLowerCase());
                            if (!category) {
                                category = { id: generateId(), name: categoryName.trim() };
                                categories.push(category);
                            }
                            
                            newExpenses.push({
                                id: parseInt(id) || generateId(), // Use existing ID or generate
                                date: formatDate(new Date(date)),
                                categoryId: category.id,
                                amount: parseFloat(amount),
                                note: (note || '').replace(/"/g, '').trim()
                            });
                        });
                        
                        if (mode === 'overwrite') {
                            expenses = newExpenses;
                        } else {
                            expenses.push(...newExpenses);
                        }
                        
                        saveData();
                        render();
                        closeModal(modalSelectors.importModal);
                        alert(`Successfully imported ${newExpenses.length} expenses.`);
                        
                    } catch (error) {
                        alert(`Error importing file: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            };

            // --- INITIALIZATION ---

            /**
             * Main initialization function
             */
            const init = () => {
                loadData();
                setupModalListeners();

                // Setup button listeners
                btnSelectors.addExpenseBtn.addEventListener('click', showAddExpenseModal);
                btnSelectors.manageCategoriesBtn.addEventListener('click', () => openModal(modalSelectors.categoriesModal));
                btnSelectors.importCsvBtn.addEventListener('click', () => openModal(modalSelectors.importModal));
                btnSelectors.exportCsvBtn.addEventListener('click', exportToCSV);
                btnSelectors.filterBtn.addEventListener('click', handleFilter);
                btnSelectors.resetFilterBtn.addEventListener('click', handleResetFilter);
                
                // Setup form listeners
                formSelectors.expenseForm.addEventListener('submit', handleExpenseFormSubmit);
                formSelectors.categoryForm.addEventListener('submit', handleCategoryFormSubmit);
                formSelectors.importForm.addEventListener('submit', handleImportCSV);
                
                // Setup table/list click listeners (event delegation)
                displaySelectors.expenseTableBody.addEventListener('click', handleExpenseTableClick);
                displaySelectors.categoryList.addEventListener('click', handleCategoryListClick);

                // Initial render
                render();
            };

            // Run the app
            init();

        });
    </script>

</body>
</html>